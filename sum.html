<!doctype html>
<html>
    <head>
    <title>Sum.wasm</title>
    </head>
  <body>
<script>
var memory = new WebAssembly.Memory({initial:1024, maximum:10000});
var imports = {
    'env': {
        'memory': memory
    }
};
fetch('sum.wasm').then(
    response =>
        response.arrayBuffer()
).catch( error =>
         console.log(error)
).then(bytes =>
       WebAssembly.instantiate(bytes, imports)
       //WebAssembly.instantiate(bytes)
).then(results => {
    const {asmSum, asmSum2 } = results.instance.exports;
    const wasmInstance = results.instance;
    console.log(wasmInstance);
    console.log(memory);
    function timeit(name,func,n) {
        var t0 = performance.now();
        for (var i = 0; i < n; i++) {
            func();
        }
        var t1 = performance.now();
        console.log("Call to "+name+" took " + (t1 - t0) + " milliseconds.");
    }
    const n = 100000;
    const p = 16;
    let typedArray = new Int32Array(memory.buffer,p,n*4);
    for (var i = 0 ; i < n; i++) {
        typedArray[i] = 100;
    }
    function jsSum(arr,n) {
        var output = 0;
        for (var i = 0 ; i < n; i++) {
            output += arr[i];
        }
        return output;
    };
    const reps = 100;
    const m = n / 2;
    for (var i = 1000 ; i < n; i+=1000) {
        if (asmSum(p,i)!=jsSum(typedArray,i)) {
            console.log(i,asmSum(p,i),jsSum(typedArray,i), asmSum(p,i)==jsSum(typedArray,i));
            break;
        }
        if (asmSum2(p,i)!=jsSum(typedArray,i)) {
            console.log(i,asmSum2(p,i),jsSum(typedArray,i), asmSum2(p,i)==jsSum(typedArray,i));
            break;
        }
    }
    console.log(asmSum2(p,n),asmSum2(p,n)==jsSum(typedArray,n));
    console.log(asmSum2(typedArray,n),asmSum2(typedArray,n)==jsSum(typedArray,n));
    console.log(jsSum(typedArray,n));
    
    
    timeit("jsSum",function(){ jsSum(typedArray,n) }, reps);
    timeit("asmSum",function(){ asmSum(p,n) }, reps);
    timeit("asmSum",function(){ asmSum(p,n) }, reps);
    timeit("asmSum2",function(){ asmSum2(p,n) }, reps);
    //timeit("asmSum2-t",function(){ asmSum2(typedArray,n) }, reps);

}).catch(e => console.log(e));
</script>
</body>
</html>

